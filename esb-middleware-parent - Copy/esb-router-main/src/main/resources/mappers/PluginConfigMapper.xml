<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.esb.middleware.mapper.PluginConfigMapper">

    <!-- Result Map for PluginConfigModel -->
    <resultMap id="PluginConfigResultMap" type="PluginConfigModel">
        <id property="id" column="id"/>
        <result property="pluginId" column="plugin_id"/>
        <result property="pluginName" column="plugin_name"/>
        <result property="version" column="version"/>
        <result property="jarFileName" column="jar_file_name"/>
        <result property="mainClass" column="main_class"/>
        <result property="description" column="description"/>
        <result property="author" column="author"/>
        <result property="vendor" column="vendor"/>
        <result property="supportedEndpoints" column="supported_endpoints"/>
        <result property="configuration" column="configuration" typeHandler="com.esb.middleware.handler.JsonTypeHandler"/>
        <result property="enabled" column="enabled"/>
        <result property="priority" column="priority"/>
        <result property="status" column="status"/>
        <result property="loadedTime" column="loaded_time"/>
        <result property="createdBy" column="created_by"/>
        <result property="createdDate" column="created_date"/>
        <result property="modifiedBy" column="modified_by"/>
        <result property="modifiedDate" column="modified_date"/>
    </resultMap>

    <!-- Base Column List -->
    <sql id="Base_Column_List">
        id, plugin_id, plugin_name, version, jar_file_name, main_class, description,
        author, vendor, supported_endpoints, configuration, enabled, priority, status,
        loaded_time, created_by, created_date, modified_by, modified_date
    </sql>

    <!-- Find plugin by plugin ID -->
    <select id="findByPluginId" resultMap="PluginConfigResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM plugin_config
        WHERE plugin_id = #{pluginId}
    </select>

    <!-- Find all plugins -->
    <select id="findAll" resultMap="PluginConfigResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM plugin_config
        ORDER BY priority DESC, plugin_name
    </select>

    <!-- Find all enabled plugins -->
    <select id="findAllEnabled" resultMap="PluginConfigResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM plugin_config
        WHERE enabled = 1
        ORDER BY priority DESC, plugin_name
    </select>

    <!-- Find plugin by JAR file name -->
    <select id="findByJarFileName" resultMap="PluginConfigResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM plugin_config
        WHERE jar_file_name = #{jarFileName}
    </select>

    <!-- Find plugin by ID -->
    <select id="findById" resultMap="PluginConfigResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM plugin_config
        WHERE id = #{id}
    </select>

    <!-- Find plugins by status -->
    <select id="findByStatus" resultMap="PluginConfigResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM plugin_config
        WHERE status = #{status}
        ORDER BY plugin_name
    </select>

    <!-- Count total plugins -->
    <select id="countTotal" resultType="int">
        SELECT COUNT(*)
        FROM plugin_config
    </select>

    <!-- Count enabled plugins -->
    <select id="countEnabled" resultType="int">
        SELECT COUNT(*)
        FROM plugin_config
        WHERE enabled = 1
    </select>

    <!-- Check if plugin exists -->
    <select id="existsByPluginId" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM plugin_config
        WHERE plugin_id = #{pluginId}
    </select>

    <!-- Insert plugin configuration -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO plugin_config (
            plugin_id, plugin_name, version, jar_file_name, main_class, description,
            author, vendor, supported_endpoints, configuration, enabled, priority,
            status, loaded_time, created_by, created_date, modified_by, modified_date
        ) VALUES (
            #{pluginId}, #{pluginName}, #{version}, #{jarFileName}, #{mainClass},
            #{description}, #{author}, #{vendor}, #{supportedEndpoints},
            #{configuration, typeHandler=com.esb.middleware.handler.JsonTypeHandler},
            #{enabled}, #{priority}, #{status}, #{loadedTime}, #{createdBy},
            #{createdDate}, #{modifiedBy}, #{modifiedDate}
        )
    </insert>

    <!-- Update plugin configuration -->
    <update id="update">
        UPDATE plugin_config SET
            plugin_name = #{pluginName},
            version = #{version},
            jar_file_name = #{jarFileName},
            main_class = #{mainClass},
            description = #{description},
            author = #{author},
            vendor = #{vendor},
            supported_endpoints = #{supportedEndpoints},
            configuration = #{configuration, typeHandler=com.esb.middleware.handler.JsonTypeHandler},
            enabled = #{enabled},
            priority = #{priority},
            status = #{status},
            loaded_time = #{loadedTime},
            modified_by = #{modifiedBy},
            modified_date = #{modifiedDate}
        WHERE id = #{id}
    </update>

    <!-- Delete plugin by ID -->
    <delete id="deleteById">
        DELETE FROM plugin_config
        WHERE id = #{id}
    </delete>

    <!-- Delete plugin by plugin ID -->
    <delete id="deleteByPluginId">
        DELETE FROM plugin_config
        WHERE plugin_id = #{pluginId}
    </delete>

    <!-- Update plugin status -->
    <update id="updateStatus">
        UPDATE plugin_config 
        SET enabled = #{enabled},
            status = #{status},
            modified_date = GETDATE()
        WHERE plugin_id = #{pluginId}
    </update>

    <!-- Update plugin loaded time -->
    <update id="updateLoadedTime">
        UPDATE plugin_config 
        SET loaded_time = #{loadedTime},
            modified_date = GETDATE()
        WHERE plugin_id = #{pluginId}
    </update>

</mapper>