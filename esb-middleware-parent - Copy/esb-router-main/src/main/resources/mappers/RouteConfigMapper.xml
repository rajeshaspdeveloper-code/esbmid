<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.esb.middleware.mapper.RouteConfigMapper">

    <!-- Result Map for RouteConfig -->
    <resultMap id="RouteConfigResultMap" type="RouteConfig">
        <id property="id" column="id"/>
        <result property="branchCode" column="branch_code"/>
        <result property="endpoint" column="endpoint"/>
        <result property="method" column="method"/>
        <result property="pluginId" column="plugin_id"/>
        <result property="targetUrl" column="target_url"/>
        <result property="headers" column="headers" typeHandler="com.esb.middleware.handler.JsonTypeHandler"/>
        <result property="parameters" column="parameters" typeHandler="com.esb.middleware.handler.JsonTypeHandler"/>
        <result property="transformationRule" column="transformation_rule"/>
        <result property="enabled" column="enabled"/>
        <result property="priority" column="priority"/>
        <result property="timeout" column="timeout"/>
        <result property="retryCount" column="retry_count"/>
        <result property="description" column="description"/>
        <result property="createdBy" column="created_by"/>
        <result property="createdDate" column="created_date"/>
        <result property="modifiedBy" column="modified_by"/>
        <result property="modifiedDate" column="modified_date"/>
    </resultMap>

    <!-- Base Column List -->
    <sql id="Base_Column_List">
        id, branch_code, endpoint, method, plugin_id, target_url, headers, parameters,
        transformation_rule, enabled, priority, timeout, retry_count, description,
        created_by, created_date, modified_by, modified_date
    </sql>

    <!-- Find route by branch and endpoint -->
    <select id="findByBranchAndEndpoint" resultMap="RouteConfigResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM route_config
        WHERE branch_code = #{branchCode}
          AND endpoint = #{endpoint}
          AND enabled = 1
        ORDER BY priority DESC
    </select>

    <!-- Find routes by branch -->
    <select id="findByBranch" resultMap="RouteConfigResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM route_config
        WHERE branch_code = #{branchCode}
        ORDER BY priority DESC, endpoint
    </select>

    <!-- Find all enabled routes -->
    <select id="findAllEnabled" resultMap="RouteConfigResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM route_config
        WHERE enabled = 1
        ORDER BY branch_code, priority DESC, endpoint
    </select>

    <!-- Find all routes -->
    <select id="findAll" resultMap="RouteConfigResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM route_config
        ORDER BY branch_code, endpoint
    </select>

    <!-- Find routes by plugin ID -->
    <select id="findByPluginId" resultMap="RouteConfigResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM route_config
        WHERE plugin_id = #{pluginId}
        ORDER BY branch_code, endpoint
    </select>

    <!-- Find route by ID -->
    <select id="findById" resultMap="RouteConfigResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM route_config
        WHERE id = #{id}
    </select>

    <!-- Count total routes -->
    <select id="countTotal" resultType="int">
        SELECT COUNT(*)
        FROM route_config
    </select>

    <!-- Count enabled routes -->
    <select id="countEnabled" resultType="int">
        SELECT COUNT(*)
        FROM route_config
        WHERE enabled = 1
    </select>

    <!-- Find routes with pagination -->
    <select id="findWithPagination" resultMap="RouteConfigResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM route_config
        ORDER BY id
        OFFSET #{offset} ROWS
        FETCH NEXT #{limit} ROWS ONLY
    </select>

    <!-- Insert route configuration -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
        INSERT INTO route_config (
            branch_code, endpoint, method, plugin_id, target_url, headers, parameters,
            transformation_rule, enabled, priority, timeout, retry_count, description,
            created_by, created_date, modified_by, modified_date
        ) VALUES (
            #{branchCode}, #{endpoint}, #{method}, #{pluginId}, #{targetUrl},
            #{headers, typeHandler=com.esb.middleware.handler.JsonTypeHandler},
            #{parameters, typeHandler=com.esb.middleware.handler.JsonTypeHandler},
            #{transformationRule}, #{enabled}, #{priority}, #{timeout}, #{retryCount},
            #{description}, #{createdBy}, #{createdDate}, #{modifiedBy}, #{modifiedDate}
        )
    </insert>

    <!-- Update route configuration -->
    <update id="update">
        UPDATE route_config SET
            branch_code = #{branchCode},
            endpoint = #{endpoint},
            method = #{method},
            plugin_id = #{pluginId},
            target_url = #{targetUrl},
            headers = #{headers, typeHandler=com.esb.middleware.handler.JsonTypeHandler},
            parameters = #{parameters, typeHandler=com.esb.middleware.handler.JsonTypeHandler},
            transformation_rule = #{transformationRule},
            enabled = #{enabled},
            priority = #{priority},
            timeout = #{timeout},
            retry_count = #{retryCount},
            description = #{description},
            modified_by = #{modifiedBy},
            modified_date = #{modifiedDate}
        WHERE id = #{id}
    </update>

    <!-- Delete route configuration -->
    <delete id="deleteById">
        DELETE FROM route_config
        WHERE id = #{id}
    </delete>

    <!-- Update route status -->
    <update id="updateStatus">
        UPDATE route_config 
        SET enabled = #{enabled},
            modified_date = GETDATE()
        WHERE id = #{id}
    </update>

</mapper>